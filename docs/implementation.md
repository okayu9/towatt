# 実装計画ドキュメント

## 技術スタックおよびビルド
- 静的HTMLファイル1枚の構成とし、生成済みのCSS/JavaScriptを直接埋め込む。
- TypeScriptでフロントエンドロジックを実装し、`tsc` によって即時実行関数（IIFE）形式のJavaScriptを生成してHTMLへ組み込む。
- 追加ライブラリは使用しない。DOM APIと標準のWeb APIのみを使用する。
- ソース管理用に以下の構成を使用する。
  - `src/index.html`（テンプレートHTML。ビルド処理で加工する前提）
  - `src/styles.css`（開発時のみ、ビルド時にHTMLへインライン化）
  - `src/main.ts`（主要ロジック）
  - `build/`（ビルド成果物一時配置。ビルド前に必ず削除してクリーン状態で生成する）
  - `dist/`（配布用最終成果物。`build/` で組み立てたHTMLをコピーする）

## 使用ライブラリ
- TypeScript（`typescript` パッケージ）。バージョンは `5.5.x` を指定する。
- 上記以外のライブラリは導入しない。本ドキュメントに明記されていないライブラリは使用しない。

## 画面構成
### 1. 対応ワット数設定画面
- 対応ワット数がクエリパラメータで指定されていない場合に表示。
- 入力項目: 数値入力フィールド（`type="number"`）、セットボタン。
- セットボタン押下時の挙動:
  - 入力値を検証後、`history.replaceState` で `?target=600` のようなクエリをアドレスバーに反映。
  - 状態を更新して換算画面へ切り替え（`viewMode` を `"calculation"` に変更）。
  - 計算画面上部に「このページをブックマークすると便利です」といった案内トーストを約5秒表示。
  - 対応ワット数付きURLはテキストで表示し、利用者が手動でコピーできるようにする。
- 値のバリデーション: 100〜3000の整数のみ（10刻みなどの制限は設けない）。

### 2. 加熱時間換算画面
- 対応ワット数がクエリで指定されている場合に表示。
- セクション構成:
  - 対応ワット数表示（設定値を強調表示）。
  - 弁当ラベル情報入力: プリセットボタン（1500 / 700 / 600 / 500）、手動入力フィールド。
  - 時間入力パッド: 0〜9の数字ボタンとクリア/バックスペースのみ（送信ボタンは設置しない）。
  - 入力パッドの4桁すべてが埋まったタイミングで自動的に換算結果表示へ遷移する。
  - 入力プレビュー: 分秒形式（例：`01:30`）と合計秒を併記。
  - 計算結果表示: 対応ワット数での加熱時間を分秒と秒の両方で提示。
  - 注意書き: 換算は目安であり食材状況に応じて調整が必要である旨を小さく表示。

## 状態管理
- 単一ファイル構成のため、状態はメモリ内で完結させる。
- 主な状態値:
  - `targetPower: number`
  - `sourcePower: number`
  - `rawTimeInput: string`（最大4桁）
  - `calculatedDuration: { minutes: number; seconds: number; totalSeconds: number }`
  - `viewMode: "setup" | "calculation"`
  - `bookmarkNoticeVisible: boolean`
- URLクエリは `new URLSearchParams(location.search)` で取得。
- 画面遷移はDOMツリー内の表示/非表示の切り替えで実装（`hidden` 属性またはCSSクラスで制御）。

## ユーザー入力処理
- プリセットボタンは選択状態を視覚的に示し、選択時に `sourcePower` を即更新。任意入力と排他制御し、任意入力フィールド変更時はプリセットの選択状態を解除。
- 時間入力パッド:
  - ボタン押下で `rawTimeInput` に文字を追加（最大4桁）。
  - `rawTimeInput` は常に4桁を想定し、上位2桁を分、下位2桁を秒として解釈する。
  - 先頭に0が含まれる場合もそのまま保持し、換算後の表示で正規化（例: `0090` → 00分90秒として受け取り、結果表示では01:30に整形）。
  - 正規化ロジック: 60秒以上の場合は `Math.floor(totalSeconds / 60)` を分、余りを秒として保持。
- 送信ボタンは配置しない。バックスペースは末尾削除、クリアは空文字に戻す。
- `rawTimeInput` が4桁に達したタイミングで入力パッドの桁が埋まったと判断し、換算処理を実行して自動的に計算結果セクションへスクロールまたは表示切り替えを行う。
- 4桁未満の入力中は換算処理を実行せず、プレビュー領域に残り桁数のガイド（例: 「あと1桁入力してください」）を表示する。
- 入力完了後のバリデーション:
  - `sourcePower` が正数、`rawTimeInput` が1桁以上。
  - 秒数が0の場合はエラー表示。
- 設定画面から計算画面へ切り替わった直後に `bookmarkNoticeVisible` を `true` にしてトーストを表示し、5秒後に自動的に `false` へ戻す。

## 計算ロジック
- 熱量一致の式: `sourcePower * sourceTime = targetPower * targetTime`。
- `sourceTime` は合計秒（整数）。
- `targetTimeSeconds = Math.round((sourcePower / targetPower) * sourceTime)`。
- 端数処理は四捨五入（`Math.round`）。必要に応じて表示上は分秒に再変換。
- 変換後の表示フォーマット: `mm:ss`（ゼロパディング2桁）と `xx秒` の両方。

## UI/UX ガイドライン
- ビューポート幅375px付近を基準に、主要ボタン幅は画面幅の40〜45%程度。
- フォントサイズ: 見出し18px、ボタン16px、注意書き12px程度を目安。
- コントラスト比は4.5:1以上。背景は淡色、ボタンはアクセントカラーを用意。
- 画面遷移時のアニメーションは最小限（`opacity` トランジション程度）。
- 結果表示は「秒カウントアップ」に見えるよう、数値を大きく中央配置。
- 設定完了後に表示するブックマーク案内トーストは画面上部に配置し、5秒程度でフェードアウトする。

## アクセシビリティ
- ボタン要素は `role=button` ではなく `<button>` を使用。
- `aria-live="polite"` を結果表示領域に設定し、計算結果が更新された際にスクリーンリーダーへ配慮。
- キーボード操作にも対応できるよう `tabindex` と `keyup` ハンドラを定義（PC利用時の互換性向上）。

## エラーメッセージ設計
- 入力不足: 「ワット数と時間を入力してください」
- 秒数が0: 「加熱時間は1秒以上で指定してください」
- 任意入力ワット数が範囲外: 「ワット数は100〜3000の範囲で指定してください」
- エラーメッセージは画面下部に赤字で表示し、自動的に5秒後にフェードアウト。

## テスト観点
- 計算検証: プリセット各種で既知のサンプル（例: 500W 03:00 → 600W 02:30）を確認。
- 入力正規化: 0990 → 09:90 → 10:30 へ変換されるか。
- URLハンドリング: `?target=600` 指定時には直接換算画面へ遷移し、`?target=` のように空値が渡された場合は設定画面にフォールバックする。非数値が指定された場合も設定画面にフォールバックする。
- レスポンシブ確認: iOS Safari/Android Chromeでビューが崩れないか。
- ブックマーク案内: 設定完了時にトーストが表示され、5秒後に消えるか確認する。
- 時間入力ガード: 4桁未満では換算処理が走らず、ガイダンス表示が出ることを確認する。

## ビルドとデプロイ手順の例
1. `src/main.ts` と `src/styles.css` を作成する。
2. `tsconfig.json` を追加し、`target` を `ES2017`、`module` を `ES2015` に設定する。
3. `npm run build` を作成し、`tsc --project tsconfig.json` を実行して `build/main.js` を生成する。生成されたコードは `IIFE` 形式になるよう `src/main.ts` の末尾で `(() => { ... })();` を構成する。
4. `npm run inline-css` を作成し、Node.jsスクリプトで `src/index.html` を `build/index.html` にコピーした上で `src/styles.css` を読み込み、改行とコメントを削除して `<style>` タグへインライン化する。スクリプトは `scripts/inline-css.mjs` として配置し、`fs.readFileSync` と `fs.writeFileSync` を使用して処理する。
5. `npm run bundle-html` を作成し、`build/main.js` を読み込んで `<script>` に埋め込み、加工済みの `build/index.html` を上書きする。バンドル後に `dist/index.html` を作成し、配布用最終成果物として保管する。

## メンテナンス指針
- プリセットワット数追加時はTypeScript側の定数とUIボタンの両方を更新。
- 計算式は単純な比率で実装する。重量の違いや具材構成の違いによる補正が必要になったときに備えて、将来的に補正係数入力欄を追加できる余白を確保する。
- バージョン管理では`docs` フォルダの仕様書と実装ファイルを同一コミットで更新するルールを推奨。
